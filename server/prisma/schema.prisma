generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password_hash String
  role          String   // 'admin' or 'consultant'
  clients       Client[]
  created_at    DateTime @default(now())

  @@map("users")
}

model Property {
  id             Int               @id @default(autoincrement())
  external_id    String?           @unique
  title          String
  price          Decimal           @db.Decimal(12, 2)
  size_m2        Decimal?          @db.Decimal(10, 2)
  rooms          String?
  district       String?
  neighborhood   String?
  url            String
  seller_phone   String?
  seller_name    String?           // Extracted seller name
  seller_type    String?           // 'owner', 'office', 'bank', 'construction'
  description    String?
  images         String[]
  features       String[]
  listing_date   DateTime?
  last_scraped   DateTime?         @default(now())
  created_at     DateTime          @default(now())
  history        PropertyHistory[]
  client_properties ClientProperty[]
  listings       PropertyListing[]

  @@index([external_id])
  @@index([last_scraped])
  @@map("properties")
}

model PropertyHistory {
  id          Int      @id @default(autoincrement())
  property_id Int
  property    Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
  price       Decimal  @db.Decimal(12, 2)
  change_type String?  // 'initial', 'price_increase', 'price_decrease'
  changed_at  DateTime @default(now())

  @@map("property_history")
}

model Client {
  id          Int      @id @default(autoincrement())
  name        String
  phone       String?
  email       String?
  notes       String?
  consultant_id Int?     // Linked Consultant
  consultant    User?    @relation(fields: [consultant_id], references: [id])
  created_at  DateTime @default(now())
  type        String   @default("buyer") // 'buyer' or 'seller'
  status      String   @default("New") // 'New', 'Active', 'Negotiation', 'Closed Won', 'Closed Lost'
  demands     Demand[]
  interactions Interaction[]
  saved_properties ClientProperty[]

  @@map("clients")
}

model Demand {
  id            Int      @id @default(autoincrement())
  client_id     Int
  client        Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  min_price     Decimal? @db.Decimal(12, 2)
  max_price     Decimal? @db.Decimal(12, 2)
  rooms         String?
  district      String?
  neighborhood  String?
  created_at    DateTime @default(now())

  @@map("demands")
}

model Interaction {
  id        Int      @id @default(autoincrement())
  client_id Int
  client    Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  type      String   // 'call', 'meeting', 'note', 'email', 'whatsapp'
  content   String?
  date      DateTime @default(now())

  @@map("interactions")
}

model ClientProperty {
  id          Int      @id @default(autoincrement())
  client_id   Int
  client      Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  property_id Int
  property    Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
  status      String   // 'suggested', 'liked', 'rejected', 'offered'
  notes       String?
  added_at    DateTime @default(now())

  @@unique([client_id, property_id])
  @@map("client_properties")
}

model PropertyListing {
  id           Int      @id @default(autoincrement())
  property_id  Int
  property     Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
  share_token  String   @unique
  created_by   Int?     // user_id of consultant who created it
  created_at   DateTime @default(now())
  expires_at   DateTime? // optional expiration
  view_count   Int      @default(0)
  custom_title       String? // Store the AI/Marketing title here
  custom_description String? // Store the AI/Marketing description here

  @@map("property_listings")
}

model SystemSetting {
  id         Int      @id @default(autoincrement())
  key        String   @unique // e.g., 'rental_rate_residential', 'rental_rate_commercial'
  value      String   // e.g., '34.88'
  updated_at DateTime @default(now())
  
  @@map("system_settings")
}
