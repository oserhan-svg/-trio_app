!function(){"use strict";function e(e,t,s,r){return new(s||(s=Promise))((function(a,n){function o(e){try{c(r.next(e))}catch(e){n(e)}}function i(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,i)}c((r=r.apply(e,t||[])).next())}))}function t(e,t,s,r){if("a"===s&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?r:"a"===s?r.call(e):r?r.value:t.get(e)}var s,r,a,n,o,i;"function"==typeof SuppressedError&&SuppressedError;const c=/((<![^>]+>)|(^<div))/i;n=new WeakMap,o=new WeakMap,s=new WeakSet,r=function(e,r,a){let n=r;const o=Object.keys(a).find((e=>"content-type"===e.toLowerCase()));if(o){a[o].includes("application/x-www-form-urlencoded")&&(n=t(this,s,"m",i).call(this,r))}else a["Content-Type"]="application/json",n=JSON.stringify(r);e.body=n},a=function(e,t){let s="";for(const[e,r]of Object.entries(t))s+=""+(s?`&${e}=${encodeURIComponent(r)}`:`${e}=${encodeURIComponent(r)}`);return`${e}${s?`?${s}`:""}`},i=function(e){const t=new URLSearchParams,s=(e,r="")=>{for(const[a,n]of Object.entries(e)){const e=r?`${r}[${a}]`:a;"object"!=typeof n||Array.isArray(n)?Array.isArray(n)?n.forEach((s=>t.append(`${e}[]`,s))):"string"==typeof n&&t.append(e,n):s(n,e)}};return s(e),t.toString()};var d=new class{constructor(){s.add(this),n.set(this,(t=>e(this,void 0,void 0,(function*(){var e;const s=t.clone();if(!t.ok)throw t;if(null===(e=t.headers.get("Content-Type"))||void 0===e?void 0:e.includes("application/json"))return t.json();{const e=yield s.text();return c.test(e.trim())?t.text():JSON.parse(e)}})))),o.set(this,(t=>e(this,void 0,void 0,(function*(){var e;if(console.error("Fetch error:",t),t instanceof Response){try{if(null===(e=t.headers.get("Content-Type"))||void 0===e?void 0:e.includes("application/json")){const e=yield t.json();if(!e)throw t;t.responseJSON=e,t.responseText=JSON.stringify(e)}else{const e=t.clone(),s=yield e.text();if(!s)throw t;/<\/?[a-z][\s\S]*>/i.test(s)||(t.responseJSON=JSON.parse(s)),t.responseText=s}}catch(e){throw console.error("Error while handling the fetch error:",e),t}throw t}throw/Maximum call stack size exceeded/i.test(null==t?void 0:t.message)&&chrome.runtime.reload(),t}))))}apiRequest(i){return e(this,void 0,void 0,(function*(){const{method:e="GET",data:c,url:d,headers:l={},signal:u}=i,h={method:e,headers:l,signal:u};let m=c,f=d;return["POST","PUT"].includes(e.toUpperCase())?t(this,s,"m",r).call(this,h,m,l):c&&Object.keys(c).length&&(f=t(this,s,"m",a).call(this,d,m)),h.headers=l,fetch(f,h).then(t(this,n,"f")).catch(t(this,o,"f"))}))}};var l,u=new class{getKeyOffersSiteToApiMapper(e){var t,s,r,a,n,o;const i={};return e.appType&&(i.appType=e.appType),e.searchQuery&&(i.searchQuery=e.searchQuery),(null===(t=e.regions)||void 0===t?void 0:t.length)&&(i.regions=e.regions),(null===(s=e.langs)||void 0===s?void 0:s.length)&&(i.langs=e.langs),(null===(r=e.genres)||void 0===r?void 0:r.length)&&(i.genres=e.genres),(null===(a=e.categories)||void 0===a?void 0:a.length)&&(i.categories=e.categories),(null===(n=e.platforms)||void 0===n?void 0:n.length)&&(i.platforms=e.platforms),null!=e.priceMin&&(i.priceMin=1e3*e.priceMin),null!=e.priceMax&&(i.priceMax=1e3*e.priceMax),null!=e.steamMin&&(i.steamMin=1e3*e.steamMin),null!=e.steamMax&&(i.steamMax=1e3*e.steamMax),null!=e.cheaperSteam&&(i.cheaperSteam=e.cheaperSteam),e.sortBy&&(i.sortBy=e.sortBy),null!=e.page&&(i.page=e.page),null!=e.limit&&(i.limit=e.limit),(null===(o=e.appId)||void 0===o?void 0:o.length)&&(i.appIds=e.appId),e.currency&&(i.currency=e.currency),i}getKeyOffersApiToSiteMapper(e){var t;const s=Array.isArray(null===(t=e.f)||void 0===t?void 0:t.a)?e.f.a:[];return{data:e.f?{currentPage:e.f.c,hasMore:e.f.b,nextPage:e.f.d,totalElements:e.f.e,items:s.map((e=>({appId:e.c,header:e.e,price:e.f,steamPrice:e.g,title:e.d,offerId:e.b,regions:e.l,platform:e.m})))}:null,success:e.e,timestamp:e.g}}getKeyOffersMetaApiToSiteMapper(e){return{prices:{min:e.a.a/1e3,max:e.a.b/1e3,steamMin:e.a.c/1e3,steamMax:e.a.d/1e3}}}};l=new WeakMap;var h=new class{constructor(){l.set(this,"https://gamestats.steaminventoryhelper.com/api/v2/")}getKeyOffers(s){return e(this,void 0,void 0,(function*(){try{const e=u.getKeyOffersSiteToApiMapper(s),r=new URLSearchParams;Object.entries(e).forEach((([e,t])=>{if(null!=t)if(Array.isArray(t)){if(0===t.length)return;r.set(e,t.join(","))}else r.set(e,String(t))}));const a=yield d.apiRequest({url:`${t(this,l,"f")}key-offers?m=1&${r.toString()}`});return u.getKeyOffersApiToSiteMapper(a)}catch(e){return{success:!1,error:e.message||e.responseJSON||"Error, something went wrong"}}}))}getMeta(){return e(this,void 0,void 0,(function*(){try{const e=yield d.apiRequest({url:`${t(this,l,"f")}key-offers/meta?m=1`});if(e.e&&e.f){const t=u.getKeyOffersMetaApiToSiteMapper(e.f);return{success:e.e,data:t}}throw new Error("Unable to get meta data")}catch(e){return{success:!1,error:e.message||e.responseJSON||"Error, something went wrong"}}}))}},m={getKeyOffers:{code:"TS_GET_KEY_OFFERS",handler:(t,s)=>e(void 0,void 0,void 0,(function*(){try{const e=yield h.getKeyOffers(t);s(e)}catch(e){s({success:!1,error:e.message||e.responseJSON||"Error, something went wrong"})}}))},getMeta:{code:"TS_GET_KEY_OFFERS_METADATA",handler:t=>e(void 0,void 0,void 0,(function*(){try{const e=yield h.getMeta();t(e)}catch(e){t({success:!1,error:e.message||e.responseJSON||"Error, something went wrong"})}}))}};const f=(t,s,r)=>e(void 0,void 0,void 0,(function*(){switch(t.type){case m.getKeyOffers.code:m.getKeyOffers.handler(t.data,r);break;case m.getMeta.code:m.getMeta.handler(r)}return!0}));var g={listener:{handler:f},init:{handler:()=>e(void 0,void 0,void 0,(function*(){chrome.runtime.onMessage.addListener(f),chrome.runtime.onMessageExternal.addListener(f)}))}};var y={handler:()=>{try{g.init.handler()}catch(e){console.log(e)}}};var p,v,R,S=new class{get(e){return new Promise(((t,s)=>{chrome.storage.sync.get(e,(e=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t(e)}))}))}set(e){return new Promise(((t,s)=>{chrome.storage.sync.set(e,(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t()}))}))}setByName({name:e,value:t}){return this.set({[e]:t})}getLocal(e){return new Promise(((t,s)=>{chrome.storage.local.get(e,(e=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t(e)}))}))}setLocal(e){return new Promise(((t,s)=>{chrome.storage.local.set(e,(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t()}))}))}setLocalByName({name:e,value:t}){return this.setLocal({[e]:t})}clear(e="sync"){"sync"===e?chrome.storage.sync.clear((()=>{})):chrome.storage.local.clear((()=>{}))}};p=new WeakSet,v=function(e=Date.now()){const t=new Date(e);return t.getHours()<12?t.setHours(12,0,0,0):(t.setDate(t.getDate()+1),t.setHours(0,0,0,0)),t.setMinutes(t.getMinutes()+5),t.getTime()},R=function(e=Date.now()){const t=[1,5,9,13,17,21],s=new Date(e);for(const e of t)if(s.getHours()<e||s.getHours()===e&&s.getMinutes()<1)return s.setHours(e,1,0,0),s.setMinutes(s.getMinutes()+5),s.getTime();return s.setDate(s.getDate()+1),s.setHours(1,1,0,0),s.setMinutes(s.getMinutes()+5),s.getTime()};var w,M=new class{constructor(){p.add(this),this.isNeedUpdateRates=s=>e(this,[s],void 0,(function*({base:e="USD",endPoint:s="rates"}){var r,a;const n="rates"!==s?"cached_steam_rates":"cached_rates",o=(yield S.get(n))[n]||{},i=null!==(a=null===(r=null==o?void 0:o[e])||void 0===r?void 0:r.updatedAt)&&void 0!==a?a:0;if(!i)return!0;const c="rates"===s?t(this,p,"m",v).call(this,i):t(this,p,"m",R).call(this,i);return Date.now()>=c})),this.setRatesInCache=t=>e(this,[t],void 0,(function*({base:e,response:t,endPoint:s="rates"}){if(!e||!(null==t?void 0:t.success))return;const r="rates"!==s?"cached_steam_rates":"cached_rates",a=(yield S.get(r))[r]||{};a[e]=Object.assign(Object.assign({},t),{updatedAt:Date.now()}),yield S.set({[r]:a})})),this.getCachedRates=t=>e(this,[t],void 0,(function*({base:e="USD",endPoint:t="rates"}){const s="rates"!==t?"cached_steam_rates":"cached_rates",r=(yield S.get(s))[s]||{};return null==r?void 0:r[e]}))}getConvertRates(e){const t=[1,100,1e3,1e4],s=e.data.base,r={base:s,ts:e.data.ts,rates:{}};for(const a in e.data.rates)if(a!==s){let n=e.data.rates[s]/e.data.rates[a];const o=n.toString();let i=0;if("0"===o[0]){i=1;for(let e=2;e<o.length&&"0"===o[e];e++)i++;i>=1&&i<=3?n*=t[i]:i>3&&(n*=t[3])}r.rates[a]={count:i<3?t[i]:t[3],number:n}}else r.rates[a]={count:1,number:e.data.rates[s]};return r}};w=new WeakMap;var b=new class{constructor(){w.set(this,(e=>new Promise((t=>{const s=[1,100,1e3,1e4],{base:r,rates:a}=e.data,n={base:r,rates:{},ts:e.data.ts};Object.entries(a).forEach((([e,t])=>{if(e===r)return void(n.rates[e]={count:1,number:t});let o=a[r]/t;const i=o.toString().match(/^0\.0*/),c=i?i[0].length-2:0;if(c>0){o*=s[Math.min(c,3)]}n.rates[e]={count:Math.min(c,3)>0?s[Math.min(c,3)]:1,number:o}})),t(n)}))))}setGlobalRates(){return e(this,void 0,void 0,(function*(){try{const{currency_code:e}=yield S.get("currency_code"),{userInfo:t}=yield S.getLocal("userInfo"),{steamCurrency:s={strCode:"USD"}}=!(null==t?void 0:t.authorization)||(yield S.get({steamCurrency:{strCode:"USD"}})),r=e||s.strCode,a=yield M.isNeedUpdateRates({}),n=yield M.isNeedUpdateRates({base:r}),o=a?yield this.fetchRates("USD"):yield M.getCachedRates({}),i=n?yield this.fetchRates(r):yield M.getCachedRates({base:r});if(!(null==o?void 0:o.success)||!(null==i?void 0:i.success))return;a&&(yield M.setRatesInCache({base:"USD",response:o})),n&&(yield M.setRatesInCache({base:r,response:i})),yield S.set({default_currency_rates:o.data}),yield S.set({currency_rates:i.data});const c=M.getConvertRates(i);yield S.set({global_currency_rates:c})}catch(e){console.error(e)}}))}setSteamRates(){return e(this,void 0,void 0,(function*(){try{const{currency_code:e}=yield S.get("currency_code"),{userInfo:t}=yield S.getLocal("userInfo"),{steamCurrency:s={strCode:"USD"}}=!(null==t?void 0:t.authorization)||(yield S.get({steamCurrency:{strCode:"USD"}})),r=e||s.strCode,a=yield M.isNeedUpdateRates({endPoint:"steam-rates"}),n=yield M.isNeedUpdateRates({base:r,endPoint:"steam-rates"}),o=a?yield this.fetchRates("USD","steam-rates"):yield M.getCachedRates({endPoint:"steam-rates"}),i=n?yield this.fetchRates(r,"steam-rates"):yield M.getCachedRates({base:r,endPoint:"steam-rates"});if(!(null==o?void 0:o.success)||!(null==i?void 0:i.success))return;a&&(yield M.setRatesInCache({base:"USD",endPoint:"steam-rates",response:o})),n&&(yield M.setRatesInCache({base:r,endPoint:"steam-rates",response:i})),yield S.set({default_steam_rates:o.data}),yield S.set({steam_rates:i.data});const c=M.getConvertRates(i);yield S.set({steam_currency_rates:c})}catch(e){console.error(e)}}))}fetchRates(e="USD",t="rates"){return d.apiRequest({url:`https://api.steaminventoryhelper.com/${t}`,data:{base:e}})}},E={getExchangeRate:{code:"exchangerate",handler:t=>e(void 0,void 0,void 0,(function*(){try{const e=yield M.isNeedUpdateRates({}),s=e?yield b.fetchRates():yield M.getCachedRates({});e&&s&&(yield M.setRatesInCache({base:"USD",response:s})),t(s)}catch(e){console.error(e),t({success:!1})}}))},getRates:{code:"GetRates",handler:(t,s)=>e(void 0,[t,s],void 0,(function*({base:e="USD"},t){try{const s=yield M.isNeedUpdateRates({base:e}),r=s?yield b.fetchRates(e):yield M.getCachedRates({base:e});s&&r&&(yield M.setRatesInCache({base:e,response:r})),t(r)}catch(e){console.error(e),t({success:!1})}}))}},_={getGlobalRates:{code:"BACKGROUND_ALARM_SET_EXCHANGE_RATES",handler:()=>e(void 0,void 0,void 0,(function*(){try{yield b.setGlobalRates()}catch(e){console.log(e)}}))},getSteamRates:{code:"BACKGROUND_ALARM_SET_STEAM_RATES",handler:()=>e(void 0,void 0,void 0,(function*(){try{yield b.setSteamRates()}catch(e){console.log(e)}}))}};const C=(t,s,r)=>e(void 0,void 0,void 0,(function*(){switch(t.type){case E.getExchangeRate.code:E.getExchangeRate.handler(r);break;case E.getRates.code:E.getRates.handler(t.data||{},r)}return!0})),A=t=>e(void 0,void 0,void 0,(function*(){switch(t.name){case _.getGlobalRates.code:yield _.getGlobalRates.handler();break;case _.getSteamRates.code:yield _.getSteamRates.handler()}}));var T={listener:{handler:C},init:{handler:()=>e(void 0,void 0,void 0,(function*(){chrome.runtime.onMessage.addListener(C),chrome.runtime.onMessageExternal.addListener(C)}))}},O={listener:{handler:A},init:{handler:()=>e(void 0,void 0,void 0,(function*(){chrome.alarms.create("BACKGROUND_ALARM_SET_EXCHANGE_RATES",{delayInMinutes:1,periodInMinutes:10}),chrome.alarms.create("BACKGROUND_ALARM_SET_STEAM_RATES",{delayInMinutes:1,periodInMinutes:10}),chrome.alarms.onAlarm.addListener(A)}))}};var U={handler:()=>{self.setGlobalRates=()=>b.setGlobalRates(),self.setSteamRates=()=>b.setSteamRates()}};({handler:()=>{try{O.init.handler(),T.init.handler()}catch(e){console.log(e)}}}).handler(),U.handler(),y.handler()}();
